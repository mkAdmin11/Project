# SKILLFACTORY FINAL PROJECT

Сценарий для настройки финального проекта SkilFactory

![](https://app.diagrams.net/?title=Project#R7V1bd6o4GP01PraLm6iPamu71mnndMaZ07X6MgshYKZAPBBbe379JNwUiJVbUE7pg20TyHXvnS%2F5PnAgz53dnadt1o%2FIAPZAEozdQL4ZSNJYHZNPmvARJihjKUywPGiESeI%2BYQl%2FgShRiFK30AB%2B6kKMkI3hJp2oI9cFOk6laZ6H3tOXmchO17rRLJBLWOqanU99hgZeR92SRvv0ewCtdVyzqE7CnJWmv1oe2rpRfQNJNoOfMNvR4rKijvprzUDvB0ny7UCeewjh8C9nNwc2Hdp42ML7Fkdyk3Z7wMVFbjBvn18W4%2B3G%2BfFz9ib74P6%2FZ%2BkqKuVNs7cg7oZqk%2FJmBnyjjcYf0UCpP7e0pTMTufjKD6ZxSi4Q5Q1BwmyfT%2F6y6O8l8N6AR6%2BISyRNCwoN85uq55%2FV1sVbckVSoSRcCwr5%2FfD38ljVUqpKKZhFQMdJJNnva4jBcqPpNPedgJ6krbFjR9m0YQvNgTYF%2FD2w3wCGukYyNBtaLknTyYSQhsgz0hyaZU%2BjDIxoUSa07TmykRfULRvAlExaro899AoOcsSpKqsqLdjTI94oUf3LqO1xe6JsUY7%2BPyxFi0qh9X4nvYKYNlwUhKTObGoeWTFMSIfA7iApQtodQA7A3ge55H3PIUmIkL8%2B4M9QGEbcjXhrJffusUv%2BiOBbAspSaSh%2FAlqpGmi%2FODylMnDMwrgVeEa5iSgfwFVWW4Wr3CRc5R6uddSUK1z9V4B1irGGsKsKeey2LLVKDrvfN8D98fTHVQwbLpDIztV%2BJoU8EubKzeJWZSFhOpkL8xHJsTzNgGQibqBHLEuIKKp8tKWDOkPJLA6F4%2BCrDIq46rhZLnLBJ%2BgLC4ntU7EZIEXo%2BIjRkkOVOGGgSokvbBxVw6Oomtt0rDqGqszUNgK2hpWJB6ok%2BSSuZKVVXKlHV1p%2Fo7kFF8YsFJOVMCyD61LYI3SP0OZX00uTwXHtLbl0ZKs8dX24Ivc2sh8XjlQSl7P2sil866PXHy%2FoPZo6WpSLPEezg1uForVYEA8UgXyut6trHTnkcud1ajjQFQm%2BFlo4stf0sn1vwyZ9PgjcBUPKm7xFBWOmzG%2BCO1jKQEYxUIaCllFGGqatHkrEuUKK6mMG1cdMO5oT0yfcmP6irVZwl1jjPd%2FL8n2NMT1%2FntIJJvQOiX6NX%2Bk%2Fmw35%2FBWMcJDd870bfBdjy%2FRshI8bxIHxd55maq7WU54H5a1wcHuqd4bqk3Ov7WJ9z9qJxX1qpTeiPdEL1vJ9SY%2BzobvddY7Qi8V8PpuxCD2djSejmwshdOa0oHl%2BK4p6bn6XdzcW5fcC2mAGtJ7bFbjtf%2FgYOD2vO8preSKem9fl%2FbJFeT2DrvF7cvroOfpnnK4mEAVadWi6n9KB9On9%2BfWviUHfB6Zd6SHdaXnQhRim5LTgvFzbiEjL6THrhtJ%2BnS1R1sHLOu4cMaRV5Sat%2BbCBpqTVtaC7a4e%2FbWsro%2BhG5PaT447q%2Bsi9nSby9K2PCSK96%2Fpt7uXpcuRJVBins%2B3q0%2FFAgbr69KhBux25OIs8FYqgKKYKjKrz1ooSgTBbxQb52IS7SlrQYEeKGmC1%2BmqgN6Cj45EoYfKqIBx6JayohMlTHTxCPbMamWyXz6eRI24aOSUjuwZSNZZ%2BNZmsb%2BQFbuzz6mRvBnZc%2FBqQOEU4HZTTrsLxi797un%2B6EMgx4kYTYH05yDF3HqyHgSSFG%2BjKh4Ll4fWMPOPJA75f3Pjrla5N2GU2vCOG1KnDPOxkXqiTyocj5VFnAmDQDU8PussEnZreQQgsrWsVdOUDY%2FKgi0JgTI%2BMMdh71XrsXRb2MrtX5eyCVz5o48SWLkz6i8Jovl0VebSixj60piOxlNfvZAC0kz7SLOL96yl5cZQcFVwOuMVbSE08B89gycYKns75QoTcWEGi0pOyc6RM22iyXHCd5EdKfp763zu4kZcTPBvfcH63fP60vsvnreZYB7rOEpvVeKgMD9%2FYUENszhhnmdjeSaAlS2OkvMZwO2eV8q97aEpjGNjvn5koxOrKj0ZcKrG%2FbGC1IoyrEZ6fUVHedXyC2qXuKGydH%2FXeIB9bHlj%2B%2BVCJG13VlUashZxr4iyh14105SV68JvQhG7hHpELMfKga3W%2Fa6xjrI52xQAOSuYo2hn%2FaxJVB%2F6pkKmuLG0d2SA3%2FsKeim%2FxGHNb1%2FgFDNw%2BfLsQ%2FHU3YKBx%2FEmZ6AG1YNxy8s7R5hHYRPTAGS2rW1vzCRZ8QPC27o2rsmtdzcOhS%2BlGnROli%2BrIMvsMcm9ldE%2Fli7xQZMQ4kx%2FxEnm5iWCd6neUeFXmN7hKvyyHZ3BxXcXmrAWl18gKbyd6zY537Wedexm6GBkSUzIkMY3NNl2DchPhW52yTh%2BQ5WPN7w3T3jCtr6S9vl60vsqM7wVh6is3t6jceIhiu2p5xNHaK2Z1%2F2tHZZPpL%2BtoX9IHsV02pLvpEOe9vWd6x1lehJFYWvfJv%2Fsv%2BQvy7vZfpCjf%2Fg8%3D )

## Начало

<br/> Настройка DMZ сервера:
```
sh -c "$(curl -fsSL https://raw.githubusercontent.com/mkAdmin11/ansible/test/start.sh)"
```
<br/> Настройка main сервера:
```
sh -c "$(curl -fsSL https://raw.githubusercontent.com/mkAdmin11/ansible/test/start_ssh.sh)"
```

## Внимание
<br/> Перед началом требуется заполнить secret.yml, за основу взять secret_sample.yml.

## Start

***Все сервера***
<br/> Первоначальная настройка всех серверов:
> Были и другие настройки, но вырезаны, т.к. для проекта они не нужны).
+ Установка некоторых нужных в дальнейшем пакетов и обновление установленных.
+ Настройка шары - в дальнейшем будет использоваться для копирования данных.
> Добавлены задачи в *cron* для взаимной синхронизации, период 2 часа.
+ Созданы шаблоны скриптов автозапуска - для поднятия через *cron* сервисов с задержкой, после перезагрузки в правильном порядке.
> *Сервер 3* - задержка 2 минуты. *Сервера 1 и 2* - задержка 5 минут.

## OpenVPN

***Сервер 1***
<br/> Поднимается *OpenVPN* сервер.
+ *VPN* cеть работает поверх локальной сети.
+ Жестко связаны *IP* адреса клиентов с их конфигами.
> Предполагается что инфраструктура выдачи ключей уже имеется и готовы пары ключей для клиентов, а также сертификаты ca и dh.
>> Использовался easy-rsa.

***Сервер 2 и 3***
<br/> Настраивается 2 клиента, подключаются к серверу с автозагрузкой.

## Bind9

***Сервер 2***
<br/> Установка *Bind9*.
<br/> Настраиваются зоны:
+ *Defaul* зона - используется *DNS* Яндекса.
+ Зона *local* - для взаимодействия всех сервисов по *VPN* сети.
> Настроены *cname*, такие как *db*, *web*, *zabbix* и т.д. для удобства администрирования.
+ Публичная зона домена.

***Все сервера***
<br/> Все сервера настраиваются на резолв через наш *DNS*.

## PostgreSQL

***Сервер 3***
<br/> Установка *PostgreSQL*.
+ Настроен доступ к *PostgreSQL* по *VPN* сети и *localhost*.
> *localhost* бедет использоваться для мониторинга через *Zabbix-agent*.
+ Созданы базы данных и пользователи с соответствующими правами, залиты схемы и первичные данные.
+ Настроены права на сетевое подключение пользователей.
> Первоначальные роли хранятся в дирректории *old*.
>> В дальнейшем восстанавливался дамп всего кластера *PostgreSQL*, т.к. накопились данные в основном от *WordPress* и *Zabbix*.
>>> При таком исполнении переносятся все базы, данные, схемы, а также пользователи со всеми правами. Остается только выдать права на сетевое подключение.

<br/> *PostgreSQL* беспечивает работу:
+ WordPress.
+ Rouncube.
+ Zabbix - база для сервиса, а также средства мониторинга PostgreSQL.
+ pgAdmin - для базы [Demo](https://postgrespro.com/education/demodb) и ее копия.

## WEB

***Сервер 2***
<br/> Установка *nginx*.
+ *nginx* доступен из интернета.
> Пока по 80 порту, по *http*.
+ *nginx* проксирует все запросы на *Apache2*.

<br/> Установка *Apache2*
+ Настроен доступ к *Apache2* полько по *VPN* сети.
> Не *localhost*, т.к. в дальнейшем *Grafana* будет обращаться к *Zabbix* напрямую через *Apache2* с *Сервера 1*.  
+ *Apache2* показывает стандартный индекс *nginx*.

<br/> Установка *PHP* и потребующихся в дальнейшем библиотек.
+ Только *Apache2* будет обрабатывать *PHP*.

> Веб сервер подготовлен для получения *SSL* сертификатов.

## Certbot

***Сервер 2***
<br/> Установка *Certbot* и получение сертификатов через *webroot*.
<br/> Дополнительная настройка *nginx*, один конфиг - три *Server*:
+ Домен второго уровня проксирует запросы на *Apache2*.
> Дополнительно проксируются запросы к сервисам которые появятся позже: *Grafana* и *Kibana*. 
+ Домен третьего уровя *forcustomer* проксирует запросы на *Apache2*. 
+ Все запросы с *http* перенаправляются на *https*.

## WWW

***Сервер 2***
<br/> Использется шара - копируется код для обработки *Apache2*:
+ *Wordress* - основа домена [второго уровня](https://admin11.tk/).
> За основу взята актуальная на момент создания версия 5.9.3.
>> Для возможности работы c *PostgreSQL* использовался проект [pg4wp](https://github.com/kevinoid/postgresql-for-wordpress).
>>> Также установлена тема *Basic* от [WP Puzzle](https://admin11.tk/wp-admin/themes.php?theme=basic) со слегка измененными стилями *CSS* и плагин [Contact Form 7](https://contactform7.com/) для создания формы обратной связи.
+ Страница картинка для домена [третьего уровня](https://forcustomer.admin11.tk/).
+ Форма обратной связи для домена [третьего уровня](https://forcustomer.admin11.tk/feedback/).
> За основу взят [этот](https://github.com/itchief/feedback-form) проект с GitHub, также внесены небольшие изменения в *PHP* код и *CSS* стили, форма упакована в страницу картинку.
+ Настроенный *Roundcube* версии 1.5.2 для [почтового сервера](https://admin11.tk/app/mail/).

<br/> Дополнительная настройка *Apache2*. Один конфиг - два *VirtualHost*:
+ Домен первого уровня.
> *ServerRoot* дирректоря *Wordpress*.
>> Tакже *Alias* в директории *Zabbix*, *mail* и *pgAdmin4*.
+ Домен третьего уровня.
>> *ServerRoot* дирректоря *forcustomer*.

## Mail

***Сервер 2***
<br/> Настройка почтового сервера:
> **!!! Первоначально на сервере установлен *Postfix* !!!**
+ Настройка *Postfix*.
+ Установка и настройка *Dovecot*.
> Используется *SSL* сертификат домена второго уровня.

## pgAdmin4

***Сервер 2***
<br/> Установка *pgAdmin4*.
> **!!! В дальнейшем требуется с сервера запустить скрипт от разработчика для настройки !!!**
+ В конфиге *Apache2* ранее настроен *Alias* для обработки *PHP* кода.
+ В *PostgreSQL* ранее подготовлены базы данных и пользователь.
+ Подключение осуществляется по *VPN* сети, настраивается через *web*-интерфейс.

## Elastic
> Добавлен репозиторий *Elastic*, точнее зеркало *Yandex*.

***Сервер 3***
<br/> Установка *Elasticsearch*:
+ Настроен доступ к *Elasticsearch* по *VPN* сети.
+ Настроена аутентификация запросов и созданы пользователи со стандартными ролями.
+ В скрипт автозапуска добавлена задача запуска службы *Elasticsearch* после перезагрузки сервера.
+ Увеличен таймаут для запуска службы *Elasticsearch*, т.к. запускается чуть дольше 2 минут.

<br/> Установлен *Kibana*:
+ Настроен доступ к *Kibana* по *VPN* сети.
+ nginx уже проксирует запросы к *Kibana* на *Сервер 3*.
+ Настроен парольный доступ к кластеру.
+ В скрипт добавлена задача запуска службы *Kibana*, после перезагрузки сервера, послe службы *Elasticsearch*.

 ## Logs
 
***Сервер 3***
> **!!! Предварительно через веб интерфейс *Kibana* создан пользователь, с ролью для записи индексов !!!**

<bt/> Установка *Logstash*:
+ Настроен доступ к *Logstash* по *VPN* сети.
+ Настроена аутентификация запросов к *Logstash*.
+ Настроена обработка логов от *web*-сервера и передача в *Elasticsearch*.
+ В скрипт автозапуска добавлена задача запуска службы *Logstash* после перезагрузки сервера, после служб *Kibana* и *Elasticsearch*.

***Сервер 2***
<br/> Установка *Filebeat*:
+ Настроен сбор логов от *nginx* и *Apache2*.
+ Отправка логов на *Сервер 3* в *Logstash*.
+ В скрипт автозапуска добавлена задача запуска службы *Filebeat* после перезагрузки сервера.
> Служба *Logstash* к тому времени должен быть уже запущена.

***Сервер 1***
<br/> Установка *Filebeat*:
+ Настроен сбор *Syslog* и *Authorization logs*, используется стандартный модуль *system*.
+ Отправка логов на *Сервер 3*, напрямую в *Elasticsearch*.
+ В скрипт добавлена задача запуска службы *Filebeat* после перезагрузки сервера.
> Служба *Elasticsearch* к тому времени должна быть уже запущена.

## Zabbix
> Добавлен репозиторий *Zabbix 5.0 TLS*.
>> В *PostgreSQL* ранее подготовлена база данных и пользователь с правами доступа по *VPN* сети.

***Сервер 1***
<br/> Установка *Zabbix-server-psql*:
+ Настроен доступ к *Zabbix-server* по *VPN* сети.
+ Настроен доступ к базе данных на *Сервере 3*.

***Сервер 2***
<br/> Установка *Zabbix-frontend-php*:
+ Настроен доступ к базе даных на *Сервере 3*.
+ Настроен доступ к *Zabbix-server* на *Сервере 1*.
+ В конфиге *Apache2* ранее настроен *Alias* для обработки *PHP фронтэнда Zabbix-а*.

***Все сервера***
<br/> Установка *Zabbix-agent*:
+ Настроен доступ к *Zabbix-server*.
+ На *Сервер 3* дополнительно установлены компоненты для мониторинга *PostgreSQL*.

## Grafana

***Сервер 1***
> Добавлен репозиторий *Grafana*.

<br/> Установка *Grafana*:
+ Настроен работа только по *VPN* сети.
+ nginx уже проксирует запросы к *Grafana* на *Сервер 1*.

<br/> Установдены плагины:
+ Плагин для подключения к *Zabbix*.
> Подключение происходит через *web*-интерфейс, для этого *Apache2* слушает *VPN* сеть.
+ Плагин для рендера графиков
> Для отправки графиков вместе с сообщениями о проблемах.






